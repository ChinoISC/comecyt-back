================================================================================
  CÓMO SUBIR EL BACKEND (Spring Boot) A RENDER.COM
================================================================================

Requisitos previos
-----------------
- Cuenta en https://render.com
- Repositorio Git con el código del backend (carpeta Back/back-comecyt o la raíz del back)
- Base de datos MySQL accesible desde internet (Render MySQL, PlanetScale, Railway, etc.)
------

PASO 1: Base de datos MySQL
----------------------------
Render ofrece "MySQL" como add-on, o puedes usar un servicio externo.

Si usas Render MySQL:
  1. En el dashboard: New + MySQL.
  2. Anota: Internal Database URL (o External si el backend estará fuera de Render).
  3. Para conectar desde el backend en Render usa la "Internal Database URL".

Si usas MySQL externo:
  - Asegúrate de que permita conexiones desde cualquier IP (0.0.0.0) o añade la IP de Render.
  - Tendrás algo como: jdbc:mysql://host:3306/nombre_bd


PASO 2: Crear Web Service en Render (Backend)
----------------------------------------------
1. Entra a https://dashboard.render.com
2. Clic en "New +" → "Web Service".
3. Conecta tu repositorio (GitHub/GitLab).
4. Configuración del servicio:

   - Name: ej. comecyt-api o back-comecyt
   - Region: elige la más cercana (ej. Oregon)
   - Branch: main (o la rama donde está el backend)

   Root Directory (importante):
   - Si todo el repo es solo el backend: deja en blanco.
   - Si el backend está en una carpeta (ej. "Back/back-comecyt"):
     Root Directory: Back/back-comecyt

   Runtime: Java

   Build Command:
     ./mvnw clean package -DskipTests
     (En Windows local usas mvnw.cmd; en Render se usa el script Unix mvnw)

   Start Command:
     java -jar target/demo-0.0.1-SNAPSHOT.jar

   Instance Type: Free (o de pago si necesitas más recursos).


PASO 3: Variables de entorno (Environment)
-------------------------------------------
En el Web Service → Environment → Add Environment Variable.
Añade estas variables (sustituye valores por los tuyos):

  KEY                      |  VALOR (ejemplo)
  -------------------------|------------------------------------------
  JAVA_VERSION             |  17
  SPRING_DATASOURCE_URL    |  jdbc:postgresql://dpg-d64ur56r433s73egagb0-a.oregon-postgres.render.com:5432/comecyt_db_portal?user=comecyt_db_portal_user&password=TU_PASSWORD_AQUI&sslmode=require
  (Sustituye TU_PASSWORD_AQUI por la contraseña real de la BD; no subas la contraseña al repo.)
  SPRING_DATASOURCE_USERNAME|  (opcional si ya va en la URL)
  SPRING_DATASOURCE_PASSWORD|  (opcional si ya va en la URL)
  SECURITY_JWT_SECRET_BASE64|  (tu clave JWT en Base64, 256 bits)
  APP_UPLOAD_DIRECTORY      |  /opt/render/project/src/usuarios

Notas:
- En Render el puerto lo asigna la variable PORT. En application.properties
  cambia la línea server.port=8083 por: server.port=${PORT:8083}
  Así en local seguirás usando 8083 y en Render usará el PORT que asigne Render.
- SECURITY_JWT_SECRET_BASE64: genera una clave segura en Base64 (32 bytes).
- APP_UPLOAD_DIRECTORY: en Render el disco no es persistente en plan free;
  para archivos persistentes usa un almacenamiento externo (S3, etc.).


PASO 4: Ajustar application.properties para producción
------------------------------------------------------
Puedes usar variables de entorno y no commitear secretos:

  server.port=${PORT:8083}
  spring.datasource.url=${SPRING_DATASOURCE_URL}
  spring.datasource.username=${SPRING_DATASOURCE_USERNAME}
  spring.datasource.password=${SPRING_DATASOURCE_PASSWORD}
  security.jwt.secret-base64=${SECURITY_JWT_SECRET_BASE64}
  app.upload.directory=${APP_UPLOAD_DIRECTORY:usuarios}

(O crea application-prod.properties y activa el perfil "prod" con SPRING_PROFILES_ACTIVE=prod).


PASO 5: Desplegar
-----------------
1. Guarda los cambios y clic en "Create Web Service".
2. Render ejecutará Build y luego Start.
3. La URL del backend será algo como: https://comecyt-api.onrender.com
4. Prueba: https://comecyt-api.onrender.com/actuator/health (si tienes actuator).


CORS
----
El backend incluye CorsFilterExplicit (prioridad máxima): responde a OPTIONS con 200
y añade Access-Control-Allow-Origin a todas las respuestas para los orígenes permitidos
(https://comecyt-front.onrender.com y http://localhost:4200). No configures "Path" en
Render para el Web Service (debe ser /) o las rutas no coincidirán (/auth/register).


Las tablas no se crean (PostgreSQL en Render)
----------------------------------------------
Con spring.jpa.hibernate.ddl-auto=update, Hibernate crea las tablas al arrancar.
Si ves "relation ... does not exist" o "permission denied for schema public":

1. Permisos en la BD: en Render → tu PostgreSQL → Connect → Shell/PSQL, ejecuta
   el script scripts/schema-postgres-render.sql (da CREATE y USAGE en schema public
   al usuario de la app, ej. comecyt_db_portal_user).

2. URL con SSL: la URL debe llevar sslmode=require:
   jdbc:postgresql://...?user=...&password=...&sslmode=require

3. Error "relation documentos/articulos does not exist": Las entidades tenían columnDefinition
   MySQL (LONGBLOB, LONGTEXT); en PostgreSQL eso falla y la tabla no se crea. Ya se quitó
   en el código; si persiste, usa SPRING_JPA_HIBERNATE_DDL_AUTO=create una vez:
   - En Render → tu Web Service → Environment, añade:
     SPRING_JPA_HIBERNATE_DDL_AUTO = create
   - Redeploy. La app creará todas las tablas desde cero y arrancará.
   - Cuando ya arranque bien, quita esa variable o cámbiala a:
     SPRING_JPA_HIBERNATE_DDL_AUTO = update
   - Vuelve a desplegar. A partir de ahí no se borrarán datos (update solo añade).

Errores frecuentes
------------------
- "Build failed": revisa que Root Directory sea correcta y que mvnw exista.
- "Application failed to start": revisa SPRING_DATASOURCE_* y que la BD sea accesible.
- Timeout en plan free: el servicio se duerme tras inactividad; la primera petición puede tardar.
- 404 en OPTIONS o POST a /auth/register con "CORS Missing Allow Origin": suele ser que el
  servicio estaba dormido (plan free). Render devuelve 404 o error antes de que Spring arranque;
  al no haber respuesta del backend, no hay cabeceras CORS. Espera 30–60 s y reintenta; la URL
  del backend debe ser la del Web Service (ej. https://comecyt-api.onrender.com) sin barra final.
  El backend debe usar server.port=${PORT:8080}; Render asigna PORT automáticamente.


Qué hacer cuando sale 404 + "falta cabecera CORS" (login/register)
-------------------------------------------------------------------
No hace falta ninguna variable de entorno extra para CORS; los orígenes ya están en el código.

1. Entra al dashboard de Render → tu Web Service del backend (comecyt-api).
2. Comprueba el estado: debe decir "Running" (verde). Si dice "Suspended" o no está en Running,
   el servicio está dormido o no arrancó.
3. Si está "Running":
   - Abre la pestaña "Logs". ¿Ves líneas de Spring Boot (Started DemoApplication...)?
   - Si la app no arrancó (error de BD, OutOfMemory, etc.), corrige y haz "Manual Deploy".
4. Si está dormido (plan Free):
   - La primera petición tras 15 min de inactividad puede devolver 404/502 sin CORS.
   - Abre en otra pestaña: https://comecyt-api.onrender.com/actuator/health
   - Espera 30–60 segundos (Render despierta el servicio). Vuelve a cargar.
   - Cuando responda {"status":"UP"} o similar, prueba de nuevo el login desde el front.
5. Variables de entorno obligatorias para que el backend arranque (Environment):
   SPRING_DATASOURCE_URL, SPRING_DATASOURCE_USERNAME, SPRING_DATASOURCE_PASSWORD
   (o user/password dentro de la URL), y SECURITY_JWT_SECRET_BASE64. PORT lo asigna Render.
6. No pongas "Path" en el Web Service (debe quedar vacío o /) para que /auth/login y
   /auth/register respondan en la raíz.

================================================================================
